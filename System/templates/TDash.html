{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher's Dashboard</title>
    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Add FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    
    <!-- Include CSS files -->
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/tdash.css' %}">
    
    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: hidden;
        }

        .modal-content {
            background-color: #fefefe;
            width: 90%;
            max-width: 1200px; /* Increased from 800px */
            margin: 2vh auto; /* Reduced from 5vh to show more content */
            max-height: 96vh; /* Increased from 90vh */
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            max-height: calc(96vh - 100px); /* Adjust based on header height */
        }

        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #000;
        }

        .student-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .student-table th,
        .student-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .student-table th {
            background-color: var(--primary);
            color: white;
        }

        .student-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .student-table tr:hover {
            background-color: #f5f5f5;
        }

        .stat-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .modal-header h2 {
            color: var(--primary);
            margin: 0;
        }

        .search-box {
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(45, 106, 79, 0.2);
        }

        /* Announcement Section Styles */
        .announcements-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 430px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .announcement-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
            scroll-behavior: smooth;
        }

        .announcement-list::-webkit-scrollbar {
            width: 6px;
        }

        .announcement-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .announcement-list::-webkit-scrollbar-thumb {
            background: #2d6a4f;
            border-radius: 10px;
        }

        .announcement-list::-webkit-scrollbar-thumb:hover {
            background: #1a4031;
        }

        .announcement-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            margin-top: 10px;
        }

        .announcement-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .announcement-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .announcement-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary);
        }

        .announcement-date {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .announcement-content {
            color: #495057;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .announcement-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
        }

        .announcement-author {
            color: #6c757d;
        }

        .btn-create {
            background-color: #ffffff;
            color: black;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .btn-create:hover {
            background-color: var(--primary-light);
        }

        .btn-delete {
            color: var(--danger);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .btn-delete:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #2d6a4f;
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .notification-header h3 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .notification-header h3 i {
            margin-right: 8px;
        }

        .notification-count {
            background-color: white;
            color: #2d6a4f;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Create Announcement Modal Styles */
        .create-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .create-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(45, 106, 79, 0.2);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        /* Calendar Section Styles */
        .calendar-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            height: 100%;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #2d6a4f;
            color: white;
            border-radius: 10px 10px 0 0;
            flex-shrink: 0;
        }

        .calendar-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: white;
            display: flex;
            align-items: center;
        }

        .calendar-header h2 i {
            margin-right: 8px;
        }

        #calendar {
            height: 500px;
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
        }

        #calendar .fc-view-harness {
            min-height: 400px;
        }

        #calendar .fc-scroller {
            overflow-y: auto !important;
        }

        #calendar .fc-scroller-liquid-absolute {
            position: relative !important;
        }

        /* Event Modal Styles */
        .event-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .event-modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .event-form-group {
            margin-bottom: 20px;
        }

        .event-form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: 500;
        }

        .event-form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .event-form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(45, 106, 79, 0.2);
        }

        .color-picker {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-option.selected {
            border-color: #000;
        }

        /* Grid Layout for Single Page */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-gap: 20px;
            padding: 0 20px;
        }

        .page-header {
            grid-column: span 12;
            padding: 15px 0;
            margin-top: -20px;
        }

        .stats-container {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            grid-gap: 20px;
            margin-bottom: -10px;
            margin-top: -33px;

        }

        .left-section {
            grid-column: span 5;
            display: flex;
            flex-direction: column;
        }

        .right-section {
            grid-column: span 7;
        }

        .announcement-content-wrap {
            padding: 15px;
        }

        @media (max-width: 1200px) {
            .left-section, 
            .right-section {
                grid-column: span 12;
            }
        }

        .needs-attention-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            padding: 10px;
        }

        .student-score {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .student-score:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .student-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2d6a4f;
            display: block;
            margin-bottom: 10px;
        }

        .evaluation-scores {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        .eval-score {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .eval-score:last-child {
            border-bottom: none;
        }

        .eval-label {
            font-weight: 500;
            color: #495057;
        }

        .score-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .not-evaluated {
            font-size: 0.9em;
            color: #6c757d;
            font-style: italic;
        }

        .score {
            font-size: 1.1em;
            font-weight: bold;
            color: #2d6a4f;
            padding: 4px 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-warning {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .warning-note {
            font-size: 0.85em;
            color: #dc3545;
            font-style: italic;
        }

        .score-details {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #dee2e6;
        }

        .score-details p {
            margin: 2px 0;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .needs-attention-list {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 1vh auto;
                max-height: 98vh;
            }

            .modal-body {
                max-height: calc(98vh - 80px);
            }
        }

        /* Scrollbar styling */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: #2d6a4f;
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #235c3f;
        }

        /* Add styles for interpretation modal */
        .interpretation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .interpretation-table th {
            background-color: #2d6a4f;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .interpretation-table td {
            padding: 12px;
            border: 1px solid #ddd;
            background-color: white;
        }

        .interpretation-table tr:hover td {
            background-color: #f5f5f5;
        }

        .btn-info {
            background-color: #2d6a4f;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }

        .btn-info:hover {
            background-color: #235c3f;
        }
    </style>
</head>
<body>
    <!-- Include the sidebar -->
    {% include 'sidebar.html' %}

    <!-- Main Content -->
    <div class="main-content">
        <div class="dashboard-grid">
            <div class="page-header">
                <h1 class="page-title">TEACHER DASHBOARD</h1>
            </div>

            <div class="stats-container">
                <!-- Total Students Card -->
                <div class="stat-card" onclick="openStudentModal()">
                    <div class="stat-icon students">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ total_students }}</h3>
                        <p>Total Pupils</p>
                    </div>
                </div>

                <!-- Total Users Card -->
                <div class="stat-card">
                    <div class="stat-icon users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3>{{ total_users }}</h3>
                        <p>Total Users</p>
                    </div>
                </div>

                <div class="stat-card" onclick="showNeedsAttentionModal()">
                    <div class="stat-icon users">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-info">
                        <h3>Pupils needing attention</h3>
                        <p>Click to view list</p>
                    </div>
                </div>
            </div>

            <div class="left-section">
                <!-- Announcements Section -->
                <div class="announcements-section">
                    <div class="notification-header">
                        <h3><i class="fas fa-bullhorn"></i> Announcements</h3>
                        <span class="notification-count">{{ recent_announcements|length }}</span>
                    </div>
                    
                    <div class="announcement-content-wrap">
                        <div class="section-header">
                            {% if request.user.is_staff %}
                            <button class="btn-create" onclick="openCreateModal()" style="background-color: #2d6a4f; color: white;">
                                <i class="fas fa-plus"></i>
                                Create Announcement
                            </button>
                            {% endif %}
                        </div>

                        <div class="announcement-list">
                            {% if recent_announcements %}
                                {% for announcement in recent_announcements %}
                                <div class="announcement-card">
                                    <div class="announcement-header">
                                        <h3 class="announcement-title">{{ announcement.title }}</h3>
                                        <span class="announcement-date">{{ announcement.created_at|date:"M d, Y" }}</span>
                                    </div>
                                    <div class="announcement-content">
                                        {{ announcement.content }}
                                    </div>
                                    <div class="announcement-footer">
                                        <span class="announcement-author">Posted by {{ announcement.created_by.username }}</span>
                                        {% if request.user.is_staff %}
                                        <button class="btn-delete" onclick="deleteAnnouncement('{% url 'delete_announcement' announcement.id %}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="announcement-card">
                                    <div class="announcement-content text-center">
                                        <i class="fas fa-info-circle"></i>
                                        No announcements available.
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-section">
                <!-- Calendar Section -->
                <div class="calendar-section">
                    <div class="calendar-header">
                        <h2><i class="fas fa-calendar"></i> Calendar of Events</h2>
                        {% if request.user.is_staff %}
                        <button class="btn-create" onclick="openEventModal()">
                            <i class="fas fa-plus"></i>
                            Add Event
                        </button>
                        {% endif %}
                    </div>
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Details Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pupil Details</h2>
                <span class="close" onclick="closeStudentModal()">&times;</span>
            </div>
            <div class="search-box">
                <input type="text" id="studentSearch" placeholder="Search students..." onkeyup="searchStudents()">
            </div>

            <table class="student-table" id="studentTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Sex</th>
                        <th>Session</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>{{ student.child_name }}</td>
                        <td>{{ student.dob|calculate_age }} years</td>
                        <td>{{ student.sex }}</td>
                        <td>{{ student.session_no }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Announcement Modal -->
    <div id="createAnnouncementModal" class="create-modal">
        <div class="create-modal-content">
            <span class="close" onclick="closeCreateModal()">&times;</span>
            <h2>Create New Announcement</h2>
            <form id="announcementForm" action="{% url 'create_announcement' %}" method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" id="title" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="content">Content</label>
                    <textarea id="content" name="content" class="form-control" required></textarea>
                </div>
                <div class="form-group" style="text-align: right;">
                    <button type="button" class="btn-create" style="background-color: #6c757d;" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn-create">Create Announcement</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="event-modal">
        <div class="event-modal-content">
            <span class="close" onclick="closeEventModal()">&times;</span>
            <h2>Add Event</h2>
            <form id="eventForm">
                <div class="event-form-group">
                    <label for="eventTitle">Title</label>
                    <input type="text" id="eventTitle" class="event-form-control" required>
                </div>
                <div class="event-form-group">
                    <label for="eventDescription">Description</label>
                    <textarea id="eventDescription" class="event-form-control"></textarea>
                </div>
                <div class="event-form-group">
                    <label for="eventStart">Start Date & Time</label>
                    <input type="datetime-local" id="eventStart" class="event-form-control" required>
                </div>
                <div class="event-form-group">
                    <label for="eventEnd">End Date & Time</label>
                    <input type="datetime-local" id="eventEnd" class="event-form-control" required>
                </div>
                <div class="event-form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <div class="color-option selected" style="background-color: #2d6a4f" data-color="#2d6a4f"></div>
                        <div class="color-option" style="background-color: #1e88e5" data-color="#1e88e5"></div>
                        <div class="color-option" style="background-color: #e53935" data-color="#e53935"></div>
                        <div class="color-option" style="background-color: #43a047" data-color="#43a047"></div>
                        <div class="color-option" style="background-color: #8e24aa" data-color="#8e24aa"></div>
                    </div>
                </div>
                <div class="form-group" style="text-align: right;">
                    <button type="button" class="btn-create" style="background-color: #6c757d;" onclick="closeEventModal()">Cancel</button>
                    <button type="submit" class="btn-create">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Needs Attention List -->
    <div id="needsAttentionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Pupils needing Attention and Leaderboards</h2>
                <div>
                    <button class="btn-create" onclick="showInterpretationModal()" style="margin-right: 10px;">
                        <i class="fas fa-info-circle"></i>
                        Score Interpretation Guide
                    </button>
                    <span class="close" onclick="closeNeedsAttentionModal()">&times;</span>
                </div>
            </div>
            <div class="modal-body">
                <div class="needs-attention-list">
                    {% for student in students %}
                        {% with scores=student.get_total_evaluation_score %}
                            <div class="student-score">
                                <span class="student-name">{{ student.child_name }}</span>
                                <div class="evaluation-scores">
                                    <div class="eval-score">
                                        <span class="eval-label">1st Evaluation:</span>
                                        <div class="score-container">
                                            {% if scores.eval1_total == 0 %}
                                                <span class="not-evaluated">Not evaluated yet</span>
                                            {% else %}
                                                <span class="score {% if scores.eval1_total < 79 %}score-warning{% endif %}">
                                                    {{ scores.eval1_total }}
                                                    {% if scores.eval1_total < 79 and scores.eval1_total > 0 %}
                                                        <span class="warning-note">This pupil needs attention</span>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="eval-score">
                                        <span class="eval-label">2nd Evaluation:</span>
                                        <div class="score-container">
                                            {% if scores.eval2_total == 0 %}
                                                <span class="not-evaluated">Not evaluated yet</span>
                                            {% else %}
                                                <span class="score {% if scores.eval2_total < 79 %}score-warning{% endif %}">
                                                    {{ scores.eval2_total }}
                                                    {% if scores.eval2_total < 79 and scores.eval2_total > 0 %}
                                                        <span class="warning-note">This pupil needs attention</span>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="eval-score">
                                        <span class="eval-label">3rd Evaluation:</span>
                                        <div class="score-container">
                                            {% if scores.eval3_total == 0 %}
                                                <span class="not-evaluated">Not evaluated yet</span>
                                            {% else %}
                                                <span class="score {% if scores.eval3_total < 79 %}score-warning{% endif %}">
                                                    {{ scores.eval3_total }}
                                                    {% if scores.eval3_total < 79 and scores.eval3_total > 0 %}
                                                        <span class="warning-note">This pupil needs attention</span>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="score-details">
                                    <p>Current Session: {{ student.session_no }}</p>
                                </div>
                            </div>
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Add the Interpretation Modal -->
    <div id="interpretationModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2><i class="fas fa-info-circle"></i> Interpretation of Standard Score</h2>
                <span class="close" onclick="closeInterpretationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <table class="interpretation-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">Standard Score</th>
                            <th>Interpretation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>69 and below</td>
                            <td>Overall development must be monitored after 3 months</td>
                        </tr>
                        <tr>
                            <td>70-79</td>
                            <td>Overall development must be monitored after 6 months</td>
                        </tr>
                        <tr>
                            <td>80-119</td>
                            <td>Average overall development</td>
                        </tr>
                        <tr>
                            <td>120-129</td>
                            <td>Slightly advanced overall development</td>
                        </tr>
                        <tr>
                            <td>130 and above</td>
                            <td>Highly advanced overall development</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

    <!-- Your custom script -->
    <script>
        // Message display functions
        function showMessage(message, type) {
            // Remove any existing message
            removeExistingMessages();
            
            // Create alert div
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;  // Removed fade show class
            alertDiv.role = 'alert';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.textAlign = 'center';
            alertDiv.style.padding = '10px 20px';  // Added padding
            alertDiv.style.borderRadius = '4px';   // Added border radius
            alertDiv.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';  // Added shadow
            
            // Set background and text color based on type
            if (type === 'success') {
                alertDiv.style.backgroundColor = '#d4edda';
                alertDiv.style.color = '#155724';
                alertDiv.style.border = '1px solid #c3e6cb';
            } else {
                alertDiv.style.backgroundColor = '#f8d7da';
                alertDiv.style.color = '#721c24';
                alertDiv.style.border = '1px solid #f5c6cb';
            }
            
            // Set the message without the 'Success!' prefix
            alertDiv.textContent = message;
            
            // Add to document
            document.body.appendChild(alertDiv);
            
            // Auto dismiss after delay
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, type === 'success' ? 3000 : 5000);
        }

        function removeExistingMessages() {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            });
        }

        // Handle announcement form submission
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('announcementForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Form submitted'); // Debug log
                    
                    const formData = new FormData(this);
                    
                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    })
                    .then(response => {
                        console.log('Response received:', response); // Debug log
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        showMessage('Announcement created successfully!', 'success');
                        closeCreateModal();
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Failed to create announcement: ' + error.message, 'error');
                    });
                });
            } else {
                console.error('Announcement form not found'); // Debug log
            }
        });

        // Modal functions
        function openStudentModal() {
            document.getElementById('studentModal').style.display = 'block';
        }

        function closeStudentModal() {
            document.getElementById('studentModal').style.display = 'none';
        }

        // Create Announcement Modal functions
        function openCreateModal() {
            document.getElementById('createAnnouncementModal').style.display = 'block';
        }

        function closeCreateModal() {
            document.getElementById('createAnnouncementModal').style.display = 'none';
        }

        // Delete Announcement function
        function deleteAnnouncement(url) {
            if (confirm('Are you sure you want to delete this announcement?')) {
                window.location.href = url;
            }
        }

        // Search function
        function searchStudents() {
            var input = document.getElementById('studentSearch');
            var filter = input.value.toLowerCase();
            var table = document.getElementById('studentTable');
            var tr = table.getElementsByTagName('tr');

            for (var i = 1; i < tr.length; i++) {
                var td = tr[i].getElementsByTagName('td')[0];
                if (td) {
                    var txtValue = td.textContent || td.innerText;
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = '';
                    } else {
                        tr[i].style.display = 'none';
                    }
                }
            }
        }

        // Event Modal functions
        function openEventModal() {
            document.getElementById('eventModal').style.display = 'block';
        }

        function closeEventModal() {
            document.getElementById('eventModal').style.display = 'none';
            document.getElementById('eventForm').reset();
        }

        // Color picker functionality
        document.querySelectorAll('.color-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelector('.color-option.selected').classList.remove('selected');
                this.classList.add('selected');
            });
        });

        // Event form submission
        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            try {
                // Get form values
                const title = document.getElementById('eventTitle').value;
                const description = document.getElementById('eventDescription').value;
                const startStr = document.getElementById('eventStart').value;
                const endStr = document.getElementById('eventEnd').value;
                const color = document.querySelector('.color-option.selected').dataset.color;

                // Validate required fields
                if (!title || !startStr || !endStr) {
                    showMessage('Please fill in all required fields (Title, Start Date, End Date)', 'error');
                    return;
                }

                // Convert local datetime strings to ISO format with timezone
                const startDate = new Date(startStr);
                const endDate = new Date(endStr);

                // Validate dates
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    showMessage('Invalid date format. Please check your dates.', 'error');
                    return;
                }

                // Create FormData object
                const formData = new FormData();
                
                // Validate required fields first
                if (!title || !startDate) {
                    showMessage('Title and start date are required', 'error');
                    return;
                }

                // Format dates as YYYY-MM-DD
                const formatDate = (date) => {
                    const d = new Date(date);
                    return d.getFullYear() + '-' + 
                           String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(d.getDate()).padStart(2, '0');
                };

                // Add form data
                formData.append('title', title.trim());
                formData.append('description', (description || '').trim());
                formData.append('start_date', formatDate(startDate));
                formData.append('end_date', formatDate(endDate));
                formData.append('color', color);  // Add the selected color

                // Log what we're sending
                console.log('Sending data:', {
                    title: title.trim(),
                    description: (description || '').trim(),
                    start_date: formatDate(startDate),
                    end_date: formatDate(endDate),
                    color: color
                });

                fetch('{% url "add_event" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => {
                    if (response.redirected) {
                        // Handle redirect (form submission success)
                        showMessage('Event created successfully!', 'success');
                        setTimeout(() => window.location.href = response.url, 1500);
                        return null;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        // If not JSON, handle as redirect
                        showMessage('Event created successfully!', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                        return null;
                    }
                })
                .then(data => {
                    if (!data) return; // Skip if redirected or not JSON
                    
                    if (data.status === 'success') {
                        if (window.calendarInstance) {
                            window.calendarInstance.refetchEvents();
                        }
                        closeEventModal();
                        showMessage(data.message || 'Event created successfully!', 'success');
                        setTimeout(() => window.location.reload(), 1500);
                    } else {
                        throw new Error(data.message || 'Failed to create event');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error creating event: ' + error.message, 'error');
                });
            } catch (error) {
                console.error('Form submission error:', error);
                showMessage('Error preparing event data. Please check all fields and try again.', 'error');
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            var studentModal = document.getElementById('studentModal');
            var createModal = document.getElementById('createAnnouncementModal');
            var eventModal = document.getElementById('eventModal');
            var needsAttentionModal = document.getElementById('needsAttentionModal');
            var interpretationModal = document.getElementById('interpretationModal');
            
            if (event.target == studentModal) {
                studentModal.style.display = 'none';
            }
            if (event.target == createModal) {
                createModal.style.display = 'none';
            }
            if (event.target == eventModal) {
                eventModal.style.display = 'none';
            }
            if (event.target == needsAttentionModal) {
                needsAttentionModal.style.display = 'none';
            }
            if (event.target == interpretationModal) {
                interpretationModal.style.display = 'none';
            }
        }

        // Calendar initialization
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                height: 'auto',
                views: {
                    timeGridWeek: {
                        titleFormat: { year: 'numeric', month: 'long', day: 'numeric' }
                    },
                    timeGridDay: {
                        titleFormat: { year: 'numeric', month: 'long', day: 'numeric' }
                    }
                },
                events: {
                    url: '{% url "get_events" %}',
                    method: 'GET',
                    failure: function(error) {
                        console.error('Error fetching events:', error);
                        alert('Error loading events. Please refresh the page.');
                    }
                },
                eventDidMount: function(info) {
                    console.log('Event mounted:', info.event);
                },
                editable: {% if request.user.is_staff %}true{% else %}false{% endif %},
                selectable: {% if request.user.is_staff %}true{% else %}false{% endif %},
                select: function(info) {
                    openEventModal();
                    document.getElementById('eventStart').value = info.startStr;
                    document.getElementById('eventEnd').value = info.endStr;
                }
            });
            
            calendar.render();
            window.calendarInstance = calendar;
        });

        // Add these functions to your existing JavaScript
        function showNeedsAttentionModal() {
            document.getElementById('needsAttentionModal').style.display = 'block';
        }

        function closeNeedsAttentionModal() {
            document.getElementById('needsAttentionModal').style.display = 'none';
        }

        function showInterpretationModal() {
            document.getElementById('interpretationModal').style.display = 'block';
        }

        function closeInterpretationModal() {
            document.getElementById('interpretationModal').style.display = 'none';
        }
    </script>
</body>
</html>